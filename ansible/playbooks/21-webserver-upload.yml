---
- name: Webserver-upload-files
  hosts: all
  become: true
  tasks:
    - name: Install rsync
      ansible.builtin.apt:
        name: rsync
        state: present
    - name: Get current git branch
      ansible.builtin.set_fact:
        branch: "{{ lookup('pipe', 'git symbolic-ref -q --short HEAD || git rev-parse --short HEAD') }}"
    - name: "Ensure /var is accessible"
      ansible.builtin.file:
        path: /var
        state: directory
        mode: "0755"
    - name: "Ensure /var/www is accessible"
      ansible.builtin.file:
        path: /var/www
        state: directory
        mode: "0755"
    - name: "Ensure /var/www/features is accessible"
      when: branch != "main"
      ansible.builtin.file:
        path: /var/www/features
        state: directory
        mode: "0755"
    - name: "Ensure directory exists"
      when: branch != "main"
      ansible.builtin.file:
        path: "/var/www/features/{{ branch }}"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
    - name: Sync feature files
      when: branch != "main"
      ansible.posix.synchronize:
        src: ../../../public/
        dest: "/var/www/features/{{ branch }}"
        delete: true
        recursive: true
        rsync_path: "rsync"
        rsync_opts:
          - "--chmod=Du=rwx,Dg=rx,Do=rx,Fu=rw,Fg=r,Fo=r"
    - name: "Ensure /var/www/production is accessible"
      when: branch == "main"
      ansible.builtin.file:
        path: /var/www/production
        state: directory
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
    - name: Sync production files
      when: branch == "main"
      ansible.posix.synchronize:
        src: ../../../public/
        dest: /var/www/production/
        delete: true
        recursive: true
        rsync_path: "rsync"
        rsync_opts:
          - "--chmod=Du=rwx,Dg=rx,Do=rx,Fu=rw,Fg=r,Fo=r"
